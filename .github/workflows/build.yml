name: Build ntfs3.ko

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      WORKSPACE: /home/runner/work/kernel-build
      CLANG_PATH: /home/runner/work/kernel-build/prebuilt/clang
      GCC_PATH: /home/runner/work/kernel-build/prebuilt/gcc
      GCC32_PATH: /home/runner/work/kernel-build/prebuilt/gcc32
      KERNEL_PATH: /home/runner/work/kernel-build/kernel/common

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up workspace
      run: |
        mkdir -p ${{ env.WORKSPACE }}
        cd ${{ env.WORKSPACE }}

    - name: Install Dependencies
      run: |
        sudo apt-get update
        # 按功能分组安装
        sudo apt-get install -y build-essential make gcc g++
        sudo apt-get install -y flex bison libssl-dev bc libelf-dev
        sudo apt-get install -y git curl unzip python3

    - name: Clone Toolchains and Kernel
      run: |
        cd ${{ env.WORKSPACE }}
        
        # 克隆工具链
        git clone --depth=1 -b 15.0 \
          https://github.com/crdroidandroid/android_prebuilts_clang_host_linux-x86_clang-vortex.git \
          ${{ env.CLANG_PATH }}
        
        git clone --depth=1 -b 15.0 \
          https://github.com/crdroidandroid/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-gnu-9.3.git \
          ${{ env.GCC_PATH }}
        
        git clone --depth=1 -b master \
          https://github.com/crdroidandroid/android_prebuilts_gcc_linux-x86_arm_arm-eabi.git \
          ${{ env.GCC32_PATH }}
        
        # 克隆内核源码
        git clone --depth=1 -b android12-5.10 \
          https://android.googlesource.com/kernel/common \
          ${{ env.KERNEL_PATH }}
        
        # 克隆NTFS3模块
        git clone --depth=1 -b master \
          https://github.com/kodhh/ntfs3-oot.git \
          ${{ env.KERNEL_PATH }}/fs/ntfs3
        
        # 集成NTFS3
        sed -i '146a source "fs/ntfs3/Kconfig"' ${{ env.KERNEL_PATH }}/fs/Kconfig
        sed -i '102a obj-$(CONFIG_NTFS3_FS) += ntfs3/' ${{ env.KERNEL_PATH }}/fs/Makefile

    - name: Configure Kernel
      run: |
        export PATH="${{ env.CLANG_PATH }}/bin:${{ env.GCC_PATH }}/bin:${{ env.GCC32_PATH }}/bin:$PATH"
        export LD_LIBRARY_PATH="${{ env.CLANG_PATH }}/lib64:$LD_LIBRARY_PATH"
        
        cd ${{ env.KERNEL_PATH }}
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux- CROSS_COMPILE_COMPAT=arm-eabi- \
          CC=clang LD=ld.lld gki_defconfig \
          CONFIG_NTFS3_FS=m CONFIG_NTFS3_64BIT_CLUSTER=n \
          CONFIG_NTFS3_LZX_XPRESS=y CONFIG_NTFS3_FS_POSIX_ACL=y \
          O=out

    - name: Build Kernel with Clang
      run: |
        export PATH="${{ env.CLANG_PATH }}/bin:${{ env.GCC_PATH }}/bin:${{ env.GCC32_PATH }}/bin:$PATH"
        export LD_LIBRARY_PATH="${{ env.CLANG_PATH }}/lib64:$LD_LIBRARY_PATH"
        
        cd ${{ env.KERNEL_PATH }}
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux- CROSS_COMPILE_COMPAT=arm-eabi- \
          CC=clang LD=ld.lld O=out -j$(nproc)

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: |
          out/fs/ntfs3/ntfs3.ko
          out/.config
