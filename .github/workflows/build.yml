name: Build ntfs3.ko

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      WORKSPACE: /home/runner/work/kernel-build
      CLANG_PATH: /home/runner/work/kernel-build/prebuilt/clang
      GCC_PATH: /home/runner/work/kernel-build/prebuilt/gcc
      GCC32_PATH: /home/runner/work/kernel-build/prebuilt/gcc32
      KERNEL_PATH: /home/runner/work/kernel-build/kernel/common

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up workspace
      run: |
        mkdir -p ${{ env.WORKSPACE }}
        cd ${{ env.WORKSPACE }}

    - name: Install Dependencies
      run: |
        sudo apt-get update
        # 按功能分组安装
        sudo apt-get install -y build-essential make gcc g++
        sudo apt-get install -y flex bison libssl-dev bc libelf-dev
        sudo apt-get install -y git curl unzip python3

    - name: Clone Toolchains and Kernel
      run: |
        cd ${{ env.WORKSPACE }}
        
        # 克隆工具链
        git clone --depth=1 -b 15.0 \
          https://github.com/crdroidandroid/android_prebuilts_clang_host_linux-x86_clang-vortex.git \
          ${{ env.CLANG_PATH }}
        
        git clone --depth=1 -b 15.0 \
          https://github.com/crdroidandroid/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-gnu-9.3.git \
          ${{ env.GCC_PATH }}
        
        git clone --depth=1 -b master \
          https://github.com/crdroidandroid/android_prebuilts_gcc_linux-x86_arm_arm-eabi.git \
          ${{ env.GCC32_PATH }}
        
        # 克隆内核源码
        git clone --depth=1 -b android12-5.10-2025-12 \
          https://android.googlesource.com/kernel/common \
          ${{ env.KERNEL_PATH }}
        
        # 克隆NTFS3模块
        git clone --depth=1 -b master \
          https://github.com/kodhh/ntfs3-oot.git \
          ${{ env.KERNEL_PATH }}/fs/ntfs3
        
        # 集成NTFS3
        sed -i '146a source "fs/ntfs3/Kconfig"' ${{ env.KERNEL_PATH }}/fs/Kconfig
        sed -i '102a obj-$(CONFIG_NTFS3_FS) += ntfs3/' ${{ env.KERNEL_PATH }}/fs/Makefile
        grep "ntfs3" ${{ env.KERNEL_PATH }}/fs/Kconfig
        grep "ntfs3" ${{ env.KERNEL_PATH }}/fs/Makefile

        cd ${{ env.KERNEL_PATH }}
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -


    - name: Configure Kernel
      run: |
        export PATH="${{ env.CLANG_PATH }}/bin:${{ env.GCC_PATH }}/bin:${{ env.GCC32_PATH }}/bin:$PATH"
        export LD_LIBRARY_PATH="${{ env.CLANG_PATH }}/lib64:$LD_LIBRARY_PATH"
        
        cd ${{ env.KERNEL_PATH }}
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux- CROSS_COMPILE_COMPAT=arm-eabi- \
          CC=clang LD=ld.lld gki_defconfig O=out

        cd out
        # 启用 NTFS3 配置
        ../scripts/config --file .config -e NTFS3_FS
        ../scripts/config --file .config -e NTFS3_LZX_XPRESS
        ../scripts/config --file .config -e NTFS3_FS_POSIX_ACL
        ../scripts/config --file .config -e NETWORK_FILESYSTEMS
        ../scripts/config --file .config -e CIFS
        ../scripts/config --file .config -d CIFS_STATS2
        ../scripts/config --file .config -e CIFS_ALLOW_INSECURE_LEGACY
        ../scripts/config --file .config -e CIFS_XATTR
        ../scripts/config --file .config -e CIFS_POSIX
        ../scripts/config --file .config -d CIFS_DEBUG
        ../scripts/config --file .config -d CIFS_DEBUG2
        ../scripts/config --file .config -d LTO_CLANG
        ../scripts/config --file .config -d LTO_CLANG_THIN

        grep "NTFS3" .config
        grep "CIFS" .config
        grep "LTO" .config

    - name: Build Kernel with Clang
      run: |
        export PATH="${{ env.CLANG_PATH }}/bin:${{ env.GCC_PATH }}/bin:${{ env.GCC32_PATH }}/bin:$PATH"
        export LD_LIBRARY_PATH="${{ env.CLANG_PATH }}/lib64:$LD_LIBRARY_PATH"
        export ABI_DEFINITION=android/abi_gki_aarch64.xml
        export TIDY_ABI=1
        export KMI_SYMBOL_LIST=android/abi_gki_aarch64
        export ADDITIONAL_KMI_SYMBOL_LISTS="
        android/abi_gki_aarch64_type_visibility
        android/abi_gki_aarch64_arg
        android/abi_gki_aarch64_core
        android/abi_gki_aarch64_db845c
        android/abi_gki_aarch64_exynos
        android/abi_gki_aarch64_exynosauto
        android/abi_gki_aarch64_fips140
        android/abi_gki_aarch64_galaxy
        android/abi_gki_aarch64_generic
        android/abi_gki_aarch64_hikey960
        android/abi_gki_aarch64_honor
        android/abi_gki_aarch64_imx
        android/abi_gki_aarch64_lenovo
        android/abi_gki_aarch64_moto
        android/abi_gki_aarch64_mtk
        android/abi_gki_aarch64_nothing
        android/abi_gki_aarch64_oplus
        android/abi_gki_aarch64_qcom
        android/abi_gki_aarch64_rockchip
        android/abi_gki_aarch64_sunmi
        android/abi_gki_aarch64_unisoc
        android/abi_gki_aarch64_virtual_device
        android/abi_gki_aarch64_vivo
        android/abi_gki_aarch64_xiaomi
        android/abi_gki_aarch64_zebra
        android/abi_gki_aarch64_asus
        android/abi_gki_aarch64_transsion
        android/abi_gki_aarch64_tuxera
        "

        cd ${{ env.KERNEL_PATH }}
        clang -v
        llvm-nm --help | head -n 1 | grep -qi llvm
        llvm-ar --help | head -n 1 | grep -qi llvm
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux- CROSS_COMPILE_COMPAT=arm-eabi- \
          CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 O=out -j$(nproc)

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: |
          ${{ env.KERNEL_PATH }}/out/arch/arm64/boot/*
          ${{ env.KERNEL_PATH }}/out/.config
