name: Build ntfs3.ko

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      WORKSPACE: /home/runner/work/kernel-build
      CLANG_PATH: /home/runner/work/kernel-build/prebuilt/clang
      GCC_PATH: /home/runner/work/kernel-build/prebuilt/gcc
      GCC32_PATH: /home/runner/work/kernel-build/prebuilt/gcc32
      KERNEL_PATH: /home/runner/work/kernel-build/kernel/common

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up workspace
      run: |
        mkdir -p ${{ env.WORKSPACE }}
        cd ${{ env.WORKSPACE }}

    - name: Install Dependencies
      run: |
        sudo apt-get update
        # 按功能分组安装
        sudo apt-get install -y build-essential make gcc g++
        sudo apt-get install -y flex bison libssl-dev bc libelf-dev
        sudo apt-get install -y wget patch git curl unzip python3

    - name: Clone Toolchains and Kernel
      run: |
        cd ${{ env.WORKSPACE }}
        
        # 克隆工具链
        git clone --depth=1 -b lineage-20.0 \
          https://github.com/LineageOS/android_prebuilts_clang_kernel_linux-x86_clang-r416183b.git \
          ${{ env.CLANG_PATH }}
        
        git clone --depth=1 -b android12L-gsi \
          https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 \
          ${{ env.GCC_PATH }}
        
        git clone --depth=1 -b android12L-gsi \
          https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 \
          ${{ env.GCC32_PATH }}
        
        # 克隆内核源码
        git clone --depth=1 -b android12-5.10-2025-12 \
          https://android.googlesource.com/kernel/common \
          ${{ env.KERNEL_PATH }}
       
        git clone --depth=1 -b android-12.1.0_r0.40 \
          https://android.googlesource.com/kernel/build \
          ${{ env.KERNEL_PATH }}/build

        # 克隆NTFS3模块
        git clone --depth=1 -b master \
          https://github.com/kodhh/ntfs3-oot.git \
          ${{ env.KERNEL_PATH }}/fs/ntfs3
        
        # 集成NTFS3
        sed -i '146a source "fs/ntfs3/Kconfig"' ${{ env.KERNEL_PATH }}/fs/Kconfig
        sed -i '102a obj-$(CONFIG_NTFS3_FS) += ntfs3/' ${{ env.KERNEL_PATH }}/fs/Makefile
        grep "ntfs3" ${{ env.KERNEL_PATH }}/fs/Kconfig
        grep "ntfs3" ${{ env.KERNEL_PATH }}/fs/Makefile

    - name: Configure Kernel
      run: |
        export PATH="${{ env.CLANG_PATH }}/bin:${{ env.GCC_PATH }}/bin:${{ env.GCC32_PATH }}/bin:$PATH"
        export LD_LIBRARY_PATH="${{ env.CLANG_PATH }}/lib64:$LD_LIBRARY_PATH"
        
        cd ${{ env.KERNEL_PATH }}
        export CROSS_COMPILE=aarch64-linux-android-
        export CROSS_COMPILE_COMPAT=arm-linux-androideabi-
        export ROOT_DIR=/home/runner/work/kernel-build/
        export KERNEL_DIR=kernel/common
        LTO=thin BUILD_CONFIG=build.config.gki.aarch64 build/build.sh OUT_DIR=out

        # 启用 NTFS3 配置
        echo "CONFIG_NTFS3_FS=y" >> out/.config
        echo "CONFIG_NTFS3_LZX_XPRESS=y" >> out/.config
        echo "CONFIG_NTFS3_FS_POSIX_ACL=y" >> out/.config
        echo "CONFIG_NETWORK_FILESYSTEMS=y" >> out/.config
        echo "CONFIG_CIFS=y" >> out/.config
        echo "CONFIG_CIFS_STATS2=n" >> out/.config
        echo "CONFIG_CIFS_ALLOW_INSECURE_LEGACY=y" >> out/.config
        echo "CONFIG_CIFS_XATTR=y" >> out/.config
        echo "CONFIG_CIFS_POSIX=y" >> out/.config
        echo "CONFIG_CIFS_DEBUG=n" >> out/.config
        echo "CONFIG_CIFS_DEBUG2=n" >> out/.config
        sed 's/CONFIG_LTO_NONE=y/CONFIG_LTO_CLANG=y/g' out/.config
        echo "CONFIG_LTO_CLANG_THIN=y" >> out/.config
        echo "CONFIG_FTRACE_MCOUNT_USE_RECORDMCOUNT=n" >> out/.config
        echo "CONFIG_KASAN=n" >> out/.config
        echo "CONFIG_KASAN_HW_TAGS=y" >> out/.config
        echo "CONFIG_GCOV_KERNEL=n" >> out/.config

    - name: Build Kernel with Clang
      run: |
        export PATH="${{ env.CLANG_PATH }}/bin:${{ env.GCC_PATH }}/bin:${{ env.GCC32_PATH }}/bin:$PATH"
        export LD_LIBRARY_PATH="${{ env.CLANG_PATH }}/lib64:$LD_LIBRARY_PATH"

        cd ${{ env.KERNEL_PATH }}
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-android- CROSS_COMPILE_COMPAT=arm-linux-androideabi- \
          CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 O=out -j$(nproc)
        cp out/.config out/upload_config

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: |
          ${{ env.KERNEL_PATH }}/out/arch/arm64/boot/*
          ${{ env.KERNEL_PATH }}/out/upload_config
